---
/**
 * Dynamic Hadith Page - SSR (English)
 * URL: /en/hadith/bukhari/1, /en/hadith/muslim/123, etc.
 */
import Layout from '../../../../layouts/Layout.astro';
import HadithSchema from '../../../../components/HadithSchema.astro';
import HadithDetailView from '../../../../components/HadithDetailView';
import type { Locale } from '../../../../i18n/translations';
import { getTranslations } from '../../../../i18n/utils';
import { loadHadiths } from '../../../../data/hadith/csvService';
import {
  slugToSource,
  generateHadithTitle,
  generateHadithDescription
} from '../../../../utils/seoHelpers';

// Get route parameters
const { source, hadithNo } = Astro.params;

// Validate params
if (!source || !hadithNo) {
  return Astro.redirect('/en/404');
}

const hadithNumber = parseInt(hadithNo, 10);
if (isNaN(hadithNumber)) {
  return Astro.redirect('/en/404');
}

// Get locale - English for this route
const currentLocale: Locale = 'en';
const t = getTranslations(currentLocale);

// Convert slug back to source name for matching
const sourceName = slugToSource(source);

// Find the hadith
const allHadiths = await loadHadiths();
const hadith = allHadiths.find(
  h => h.source.trim().toLowerCase().includes(source.toLowerCase()) &&
       h.hadithNo === hadithNumber
);

// 404 if not found
if (!hadith) {
  return Astro.redirect('/en/404');
}

// Generate SEO metadata
const title = generateHadithTitle(hadith.source, hadith.hadithNo, currentLocale);
const description = generateHadithDescription(hadith, currentLocale);
---

<Layout
  title={title}
  description={description}
  type="article"
>
  <HadithSchema slot="schema" hadith={hadith} locale={currentLocale} />

  <!-- Server-rendered hadith content for SEO -->
  <article class="max-w-4xl mx-auto p-4">
    <header class="mb-6">
      <h1 class="text-2xl font-bold mb-2">
        {hadith.source.trim()} - Hadith {hadith.hadithNo}
      </h1>
      <p class="text-gray-400">
        Chapter: {hadith.chapter}
      </p>
    </header>

    <!-- English Translation -->
    <section class="mb-6 p-4 bg-gray-800/50 rounded-lg" dir="ltr" lang="en">
      <h2 class="text-lg font-semibold mb-2">English Translation</h2>
      <p class="text-lg leading-relaxed">
        {hadith.textEn}
      </p>
    </section>

    <!-- Arabic Text -->
    <section class="mb-6 p-4 bg-gray-800/50 rounded-lg" dir="rtl" lang="ar">
      <h2 class="text-lg font-semibold mb-2 text-right">Arabic Text</h2>
      <p class="text-lg leading-relaxed font-['Amiri_Quran'] text-right">
        {hadith.textAr}
      </p>
    </section>

    <!-- Interactive Isnad Visualization (client-side) -->
    <section class="mt-8">
      <h2 class="text-xl font-semibold mb-4">Chain of Narration (Isnad)</h2>
      <HadithDetailView
        client:load
        locale={currentLocale}
        t={t}
        initialHadithId={hadith.id}
      />
    </section>
  </article>
</Layout>
