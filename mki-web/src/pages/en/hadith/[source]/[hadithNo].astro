---
/**
 * Dynamic Hadith Page - SSR (English)
 * URL: /en/hadith/bukhari/1, /en/hadith/muslim/123, etc.
 *
 * Server-renders SEO content and loads the full HadithDetailView
 * with the existing design (flowchart, narrator details, etc.)
 */
import Layout from '../../../../layouts/Layout.astro';
import HadithSchema from '../../../../components/HadithSchema.astro';
import HadithDetailView from '../../../../components/HadithDetailView';
import type { Locale } from '../../../../i18n/translations';
import { getTranslations } from '../../../../i18n/utils';
import { getHadithBySourceAndNumber } from '../../../../data/hadith/d1Service';
import {
  slugToSource,
  generateHadithTitle,
  generateHadithDescription
} from '../../../../utils/seoHelpers';

// Get route parameters
const { source, hadithNo } = Astro.params;

// Validate params
if (!source || !hadithNo) {
  return Astro.redirect('/en/404');
}

const hadithNumber = parseInt(hadithNo, 10);
if (isNaN(hadithNumber)) {
  return Astro.redirect('/en/404');
}

// English locale for this route
const currentLocale: Locale = 'en';
const t = getTranslations(currentLocale);

// Get D1 database
const db = Astro.locals.runtime.env.DB;

// Convert slug back to source name for matching
const sourceName = slugToSource(source);

// Find the hadith using D1
const hadith = await getHadithBySourceAndNumber(db, sourceName, hadithNumber);

// 404 if not found
if (!hadith) {
  return Astro.redirect('/en/404');
}

// Generate SEO metadata
const title = generateHadithTitle(hadith.source, hadith.hadithNo, currentLocale);
const description = generateHadithDescription(hadith, currentLocale);
---

<Layout
  title={title}
  description={description}
  type="article"
>
  <HadithSchema slot="schema" hadith={hadith} locale={currentLocale} />

  <!-- Server-rendered content for SEO (hidden when JS loads) -->
  <noscript>
    <article class="max-w-4xl mx-auto p-4" dir="ltr" lang="en">
      <h1 class="text-2xl font-bold mb-4">
        {hadith.source.trim()} - Hadith {hadith.hadithNo}
      </h1>
      <p class="text-gray-400 mb-4">Chapter: {hadith.chapter}</p>
      <div class="p-4 bg-gray-800/50 rounded-lg mb-4">
        <h2 class="text-lg font-semibold mb-2">English Translation</h2>
        <p class="text-lg leading-relaxed">{hadith.textEn}</p>
      </div>
      <div class="p-4 bg-gray-800/50 rounded-lg" dir="rtl" lang="ar">
        <h2 class="text-lg font-semibold mb-2">Arabic Text</h2>
        <p class="text-lg leading-relaxed">{hadith.textAr}</p>
      </div>
    </article>
  </noscript>

  <!-- Hidden SEO content for crawlers (invisible to users, visible to search engines) -->
  <div class="sr-only" aria-hidden="true">
    <h1>{hadith.source.trim()} - Hadith {hadith.hadithNo}</h1>
    <p>Chapter: {hadith.chapter}</p>
    <p>{hadith.textEn}</p>
    <p>{hadith.textAr}</p>
  </div>

  <!-- Full Interactive Hadith View with existing design -->
  <HadithDetailView
    client:load
    locale={currentLocale}
    t={t}
    initialHadith={hadith}
  />
</Layout>
